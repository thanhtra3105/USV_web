<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üö§ USV Mission Planner (MQTT)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDl7j1gjfJ-OentAm-aqDHu81p-Kv3WHos"></script>
</head>
<body class="bg-gray-100">
  <div class="bg-blue-700 text-white p-4">
    <h1 class="text-2xl font-bold">üö§ USV Mission Planner (MQTT)</h1>
  </div>

  <div class="flex min-h-screen">
    <!-- Left: Map -->
    <div class="flex-1 relative">
      <div id="map" class="w-full h-full"></div>
      <div class="absolute top-4 left-4 bg-white p-3 rounded-lg shadow space-x-2">
        <button onclick="clearWaypoints()" class="bg-red-500 text-white px-3 py-1 rounded">Clear</button>
        <button onclick="uploadMission()" class="bg-green-600 text-white px-3 py-1 rounded">Upload</button>
        <button onclick="startMission()" class="bg-blue-600 text-white px-3 py-1 rounded">Start</button>
        <button onclick="armVehicle()" class="bg-yellow-500 text-white px-3 py-1 rounded">ARM</button>
        <button onclick="disarmVehicle()" class="bg-gray-600 text-white px-3 py-1 rounded">DISARM</button>
      </div>
      <div id="progress-container" class="absolute bottom-4 left-4 w-1/3 bg-gray-200 rounded">
        <div id="progress-bar" class="h-3 bg-blue-500 rounded" style="width: 0%"></div>
      </div>
    </div>

    <!-- Right: Telemetry -->
    <div class="w-80 bg-white p-6 border-l border-gray-200 shadow-lg">
      <h3 class="text-xl font-semibold mb-4">üìä Telemetry</h3>
      <div id="telemetry" class="space-y-2 text-gray-800 text-sm">
        <p><b>Speed:</b> <span id="speed">--</span> m/s</p>
        <p><b>Heading:</b> <span id="heading">--</span>¬∞</p>
        <p><b>Battery:</b> <span id="battery">--</span>%</p>
        <p><b>pH:</b> <span id="ph">--</span></p>
        <p><b>DO:</b> <span id="do">--</span></p>
        <p><b>COD:</b> <span id="cod">--</span></p>
        <p><b>TSS:</b> <span id="tss">--</span></p>
      </div>
    </div>
  </div>

  <script>
    // ===================== MQTT CONFIG =====================
    const broker = "wss://broker.emqx.io:8084/mqtt"; // d√πng EMQX WebSocket
    const topicTelemetry = "usv/telemetry";
    const topicMissionUpload = "usv/command/mission";
    const topicMissionStart = "usv/command/start";
    const topicArm = "usv/command/arm";
    const topicDisarm = "usv/command/disarm";

    const client = mqtt.connect(broker);

    client.on("connect", () => {
      console.log("‚úÖ Connected to MQTT broker");
      client.subscribe(topicTelemetry);
    });

    client.on("message", (topic, message) => {
      if (topic === topicTelemetry) {
        const data = JSON.parse(message.toString());
        updateTelemetry(data);
        updateVehicleMarker(data);
      }
    });

    // ===================== GOOGLE MAP =====================
    let map, waypoints = [], markers = [], polyline = null, vehicleMarker = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 16.0659, lng: 108.1609 },
        zoom: 16,
        //mapTypeId: "satellite",
        gestureHandling: "greedy" // Cho ph√©p zoom b·∫±ng scroll lu√¥n
      });

      // Click ƒë·ªÉ t·∫°o waypoint
      map.addListener("click", (event) => addWaypoint(event.latLng));
    }

    function addWaypoint(latLng) {
      const idx = waypoints.length + 1;
      const marker = new google.maps.Marker({
        position: latLng,
        map,
        label: `${idx}`,
        draggable: true,
        icon: {
          url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        }
      });

      // L∆∞u waypoint
      waypoints.push({ lat: latLng.lat(), lng: latLng.lng(), hold_time: 2 });
      markers.push(marker);
      drawPolyline();

      marker.addListener("dragend", () => {
        const pos = marker.getPosition();
        waypoints[idx - 1] = { lat: pos.lat(), lng: pos.lng(), hold_time: 2 };
        drawPolyline();
      });
    }

    function drawPolyline() {
      if (polyline) polyline.setMap(null);
      if (waypoints.length >= 2) {
        polyline = new google.maps.Polyline({
          path: waypoints.map(wp => ({ lat: wp.lat, lng: wp.lng })),
          geodesic: true,
          strokeColor: "#FF0000",
          strokeOpacity: 0.8,
          strokeWeight: 3
        });
        polyline.setMap(map);
      }
    }

    function clearWaypoints() {
      markers.forEach(m => m.setMap(null));
      markers = [];
      waypoints = [];
      if (polyline) polyline.setMap(null);
      console.log("üßπ Cleared all waypoints");
    }

    // ===================== TELEMETRY DISPLAY =====================
    function updateTelemetry(t) {
      document.getElementById("speed").innerText = t.speed?.toFixed(2) ?? "--";
      document.getElementById("heading").innerText = t.heading?.toFixed(1) ?? "--";
      document.getElementById("battery").innerText = t.battery?.toFixed(1) ?? "--";
      document.getElementById("ph").innerText = t.ph?.toFixed(1) ?? "--";
      document.getElementById("do").innerText = t.do?.toFixed(1) ?? "--";
      document.getElementById("cod").innerText = t.cod?.toFixed(1) ?? "--";
      document.getElementById("tss").innerText = t.tss?.toFixed(1) ?? "--";
    }

    function updateVehicleMarker(pos) {
      if (!pos.lat || !pos.lon) return;
      const position = { lat: pos.lat, lng: pos.lon };
      if (!vehicleMarker) {
        vehicleMarker = new google.maps.Marker({
          position,
          map,
          icon: {
            url: "https://cdn-icons-png.flaticon.com/512/3448/3448339.png",
            scaledSize: new google.maps.Size(35, 35)
          },
          title: "USV Position"
        });
      } else {
        vehicleMarker.setPosition(position);
      }
    }

    // ===================== COMMANDS =====================
    function uploadMission() {
      if (waypoints.length === 0) return alert("‚ö†Ô∏è No waypoints to upload");
      client.publish(topicMissionUpload, JSON.stringify({ mission: waypoints }));
      updateProgress(100, true);
      alert("‚úÖ Mission uploaded");
    }

    function startMission() {
      client.publish(topicMissionStart, "1");
      alert("üöÄ Mission started");
    }

    function armVehicle() {
      client.publish(topicArm, "1");
      alert("üü¢ Vehicle armed");
    }

    function disarmVehicle() {
      client.publish(topicDisarm, "0");
      alert("üî¥ Vehicle disarmed");
    }

    function updateProgress(pct, ok = false) {
      const bar = document.getElementById("progress-bar");
      bar.style.width = pct + "%";
      bar.style.background = ok ? "green" : "blue";
    }

    window.onload = initMap;
  </script>
</body>
</html>
